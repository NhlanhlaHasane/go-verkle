package verkle

import (
	"bytes"
	"github.com/ethereum/go-ethereum/common"
	"github.com/protolambda/go-kzg/bls"
	"testing"
)

func TestGoerliInsertBug(t *testing.T) {
	root := New(10, lg1)
	root.InsertOrdered(common.Hex2Bytes("000c6df36c9d5df27db6176864953e5de974bbb143f3a1fa9349731bd0d25843"), common.Hex2Bytes("f84b02871513636f4e0d40a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000c77933138c074dad42979a48d385d5c5b94776376673b1dfcc1cc7b79fc7b"), common.Hex2Bytes("f84b02870ce4fae7a78400a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000c7baba3e24fc663998c840b2bc29b85df9bf882417cf8e8dda2176b756ef1"), common.Hex2Bytes("f8440180a0a93dc124d8c22105f41b33ca605cddd7ad30de0b803b2cd76d7be9507d77f125a010b37de11f39e0a372615c70e1d4d7c613937e8f61823d59be9bea62112e175c"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000c80c300fd10413c25004d80b2ed4c0fc21548104190be225d5bf43f5df9e8"), common.Hex2Bytes("f8440280a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000c84ddd29113acba9a80696a4927649e1108861575f51536cfa04986c5a4d5"), common.Hex2Bytes("f84b0a8737d887afc20a00a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000c9f87eb59996c38b587bb3a5a49b85a64b8b6bb7dd76e87125fe1370071a2"), common.Hex2Bytes("f84b018701d7c17cd98200a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000ca9506198b51956083dabde9b3c5c0c4251b56ea4741396ce02631c4be379"), common.Hex2Bytes("f84b018701d7b0b950b200a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000ca9538ed7e9a5688464cc41c8c5f20af324c76ea78360abe7d57185c23834"), common.Hex2Bytes("f8440180a01a67cc51538c651f63e8d55094b0ae7bca7f623f05a9ff77ca815dd44d5c8322a010b37de11f39e0a372615c70e1d4d7c613937e8f61823d59be9bea62112e175c"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000cb297d4ce722e261991118ccc6ea24b1a4ae7b08786d04798b32ba0c5e8b5"), common.Hex2Bytes("f8440180a05156f020d2fedce53aa29326c168e0e9b523a3045c7bbb7c4843a5fba1c68833a010b37de11f39e0a372615c70e1d4d7c613937e8f61823d59be9bea62112e175c"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000cb5358a9a8d71bf3e87c36c2ce3fc5e704da4f02e95d3c0204587623b2e0b"), common.Hex2Bytes("f84b0187019ce2c21e0580a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000cb862bcf2e445896e34f1c5ffc8b41211e26dec1b9927920e9a13ab035bff"), common.Hex2Bytes("f84b808705ff3a20554b00a056e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421a0c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000ccb17bbe7f72c6bb71378b84a45065a2d82a0100b00ec5f4ce44fe85e9756"), common.Hex2Bytes("f8440180a0fcf42521114702f593805cf5825a1545a8b6aea1fe5a0ab689e8f79a9c8a383da010b37de11f39e0a372615c70e1d4d7c613937e8f61823d59be9bea62112e175c"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000cd733b70363846dfdb0f01e6881623bcd7abb45461b765f0da9ca362abbec"), common.Hex2Bytes("f8440180a022f6d60030289cd6aa8d6a67b4097a6b1f391ee55a4992a6ed1be0ec5884d49ea010b37de11f39e0a372615c70e1d4d7c613937e8f61823d59be9bea62112e175c"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000ce4c74bdb54168dc275c7af84789fdb6d27c22f50ffe9c620677bf6e56163"), common.Hex2Bytes("f8440180a05b46fb6682b6b35845164885c2d0f8bc47cbda8635ace237a6734941a5c3ab56a010b37de11f39e0a372615c70e1d4d7c613937e8f61823d59be9bea62112e175c"), ks, nil)
	root.InsertOrdered(common.Hex2Bytes("000ce6342e4200d6dfa021da392af54c898a7fc95f682f610548d56c173bde31"), common.Hex2Bytes("f8440180a037b1641cb776e311e8911a4030f881714e649c8b6297e66b517150bbe81051d0a0ba2bb17cbdccac7cdd28bcf212f4a56cad24a4e4dba88eb6268d3b281f4e1290"), ks, nil)
	expected := common.Hex2Bytes("82976b7afed250316443c703153269bbbcf7b7531cc0a12ae48c97c863bb1c38c70f38eafa7c71c79d680b0132b9e0cb")

	comm := root.ComputeCommitment(ks)
	got := bls.ToCompressedG1(comm)

	if !bytes.Equal(got, expected) {
		t.Fatalf("incorrect root commitment %x != %x", got, expected)
	}
}
